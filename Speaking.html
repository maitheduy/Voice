<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Deutsch Kids Player ‚Äî JSON Audio Cards + Vietnamese Meaning</title>
<style>
  :root {
    --bg: #0f172a; --panel: #111827; --soft: #1f2937; --text: #e5e7eb; --muted: #9ca3af;
    --accent: #22c55e; --accent-2: #60a5fa; --danger: #ef4444;
    --gap: 12px; --radius: 14px; --fontScale: 1.4;
  }
  html, body { height: 100%; }
  body {
    margin: 0; background: radial-gradient(1200px 800px at 10% 0%, #0b1220, var(--bg));
    color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Noto Sans";
    display: grid; place-items: center; padding: 16px;
  }
  .app { width: min(980px, 100%); display: grid; gap: var(--gap); }
  .toolbar, .loader, .panel, .card, .footer {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0));
    border: 1px solid #1f2a44; border-radius: var(--radius);
    box-shadow: 0 15px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .toolbar, .loader, .footer { padding: 10px 12px; }
  .toolbar { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; }
  .toolbar .left, .toolbar .right { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .toolbar .center { display: flex; gap: 8px; justify-content: center; align-items: center; flex-wrap: wrap; }
  .btn {
    appearance: none; border: 1px solid #223152; color: var(--text); background: #0b1324;
    padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; letter-spacing: .2px;
    transition: transform .06s ease, background .2s ease, border-color .2s ease; user-select: none;
  }
  .btn:active { transform: translateY(1px) scale(0.99); }
  .btn.primary { background: linear-gradient(180deg, #1b2d52, #0e1a34); border-color: #2c3f66; }
  .btn.good { background: linear-gradient(180deg, #19412a, #0d2317); border-color: #2d5b3e; }
  .btn.bad { background: linear-gradient(180deg, #4a1b1b, #2a0f0f); border-color: #6b2222; }
  .btn.ghost { background: #0b1324; }
  .kbd { border: 1px solid #334155; background: #0b1222; padding: 2px 6px; border-radius: 6px; color: var(--muted); font-size: 12px; }
  .sep { width: 1px; height: 28px; background: #223152; margin: 0 6px; }
  .loader { display: grid; gap: 8px; }
  .loader .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .loader .row input[type="file"] { display: none; }
  .drop {
    border: 2px dashed #25406d; border-radius: 12px; padding: 10px; color: var(--muted);
    text-align: center; transition: border-color .2s ease, background .2s ease;
  }
  .drop.dragover { border-color: var(--accent-2); background: rgba(96,165,250,0.08); color: #cfe4ff; }
  .panel { display: grid; gap: var(--gap); padding: 14px; }
  .meta { display: flex; justify-content: space-between; gap: 8px; align-items: baseline; flex-wrap: wrap; }
  .meta .idx { color: var(--muted); font-weight: 600; }
  .meta .title { font-size: calc(18px * var(--fontScale)); font-weight: 800; letter-spacing: .3px; }
  .meta .tips { color: var(--muted); font-size: 12px; }
  .card { padding: 14px; display: grid; gap: 12px; }
  .desc { font-size: calc(22px * var(--fontScale)); line-height: 1.35; font-weight: 700; letter-spacing: .2px; }
  
  /* üî∏ D·ªäCH & GHI √ÇM: N·ªòI DUNG V√ÄNG, NH√ÉN TR·∫ÆNG */
  .trans, .record {
    font-size: calc(18px * var(--fontScale));
    line-height: 1.4;
    color: #fde047; /* ‚Üê N·ªòI DUNG CH√çNH: V√ÄNG */
    background: #0b1324;
    border: 1px solid #1f3b2a;
    border-radius: 10px;
    padding: 10px;
  }

  .trans .label, .record .label {
    font-size: 12px;
    color: var(--text); /* ‚Üê NH√ÉN: TR·∫ÆNG (theo theme) */
    text-transform: uppercase;
    letter-spacing: .8px;
    margin-right: 8px;
    font-weight: 700;
  }

  #viText {
    color: #fde047; /* ‚Üê B·∫¢N D·ªäCH HI·ªÜN TH·ªä M√ÄU V√ÄNG */
  }

  #viText.empty {
    color: #93a2b1; /* ‚Üê "(ch∆∞a c√≥ d·ªãch)" v·∫´n x√°m */
    font-style: italic;
  }

  .trans .row, .record .row { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .trans textarea, .record textarea {
    width: 100%; min-height: 90px; background: #07101f; color: var(--text);
    border: 1px solid #223152; border-radius: 10px; padding: 10px; resize: vertical;
  }
  .embed { background: #0b1324; border: 1px dashed #263657; border-radius: 10px; padding: 12px; display: grid; place-items: center; }
  .grid { display: grid; gap: 8px; }
  .controls { display: grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap: 8px; }
  .controls .btn { width: 100%; }
  .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  label { font-size: 13px; color: var(--muted); }
  input[type="range"] { width: 180px; }
  input[type="number"] {
    width: 80px; padding: 8px 10px; background: #0b1324; border: 1px solid #223152; color: var(--text); border-radius: 10px;
  }
  textarea { width: 100%; min-height: 120px; background: #0b1324; color: var(--text); border: 1px solid #223152; border-radius: 10px; padding: 10px; resize: vertical; }
  .status { color: var(--muted); font-size: 12px; }
  .footer { color: var(--muted); text-align: center; font-size: 12px; }
  .tag { padding: 2px 8px; border-radius: 999px; border: 1px solid #2b3c5d; background: #0b1324; color: #c7d2fe; font-weight: 600; }
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* === TABS === */
  .tabs { display: flex; gap: 8px; margin-bottom: 8px; }

  .tab-btn {
    padding: 6px 12px;
    border-radius: 8px;
    background: #0b1324;
    border: 1px solid #223152;
    color: var(--text); /* ch·ªØ tr·∫Øng */
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .tab-btn:hover {
    background: #111827;
    border-color: #334155;
  }

  .tab-btn.active {
    background: #fde047; /* ‚Üê N·ªÄN V√ÄNG */
    border-color: #facc15;
    color: #111827; /* ‚Üê CH·ªÆ ƒêEN */
    box-shadow: 0 0 0 2px rgba(253, 224, 71, 0.3);
  }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* === HI·ªÜU ·ª®NG CH·∫§M ƒê·ªé NH·∫§P NH√ÅY === */
  .recording-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    background: #ef4444;
    border-radius: 50%;
    animation: blink 1s infinite;
  }

  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
  }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="toolbar">
    <div class="left">
      <button class="btn ghost toggle" id="shuffleBtn" aria-pressed="false" title="B·∫≠t/T·∫Øt ph√°t ng·∫´u nhi√™n (S)">üîÄ Shuffle <span class="kbd">S</span></button>
      <span class="sep" aria-hidden="true"></span>
      <span class="status">Ch·ªâ chuy·ªÉn khi b·∫•m <span class="kbd">Next</span> ho·∫∑c ph√≠m <span class="kbd">‚Üí</span>. B·∫•m <span class="kbd">E</span> ƒë·ªÉ s·ª≠a d·ªãch.</span>
    </div>
    <div class="center">
      <button id="prevBtn" class="btn" title="Tr∆∞·ªõc (‚Üê)"><span aria-hidden="true">‚üµ</span> Prev</button>
      <button id="playBtn" class="btn primary" title="Ph√°t l·∫°i (Space)">Play <span class="kbd">Space</span></button>
      <button id="nextBtn" class="btn" title="Ti·∫øp (‚Üí)">Next <span aria-hidden="true">‚ü∂</span></button>
    </div>
    <div class="right">
      <label for="fontRange">C·ª° ch·ªØ</label>
      <input id="fontRange" type="range" min="0.8" max="1.8" step="0.05" value="1.4" />
      <span class="tag" id="countTag">0 / 0</span>
    </div>
  </div>

  <div class="loader" id="loader">
    <div class="row">
      <strong>N·∫°p d·ªØ li·ªáu:</strong>
      <label class="btn" for="fileInput">Ch·ªçn t·ªáp JSON</label>
      <input id="fileInput" type="file" accept=".json,application/json" />
      <button id="loadFromTextarea" class="btn good">D√πng JSON ƒë√£ d√°n</button>
      <button id="useSample" class="btn">D√πng m·∫´u m·∫∑c ƒë·ªãnh</button>
      <span class="status" id="loadStatus">C√≥ th·ªÉ k√©o‚Äìth·∫£ t·ªáp JSON v√†o v√πng ph√≠a d∆∞·ªõi.</span>
    </div>
    <div class="drop" id="dropZone" aria-label="K√©o‚Äìth·∫£ t·ªáp JSON v√†o ƒë√¢y">
      K√©o‚Äìth·∫£ t·ªáp JSON v√†o ƒë√¢y, ho·∫∑c d√°n JSON v√†o √¥ b√™n d∆∞·ªõi, r·ªìi b·∫•m ‚ÄúD√πng JSON ƒë√£ d√°n‚Äù.
    </div>
    <textarea id="jsonTextarea" placeholder='D√°n m·∫£ng JSON d·∫°ng [{"embed":"...iframe...","description":"Deutsch...","vietnameseTranslation":"d·ªãch ti·∫øng Vi·ªát..."}, ...]'></textarea>
  </div>

  <div class="panel" id="playerPanel" hidden>
    <div class="meta">
      <div class="idx" id="indexInfo">#1</div>
      <div class="title">Deutsch Kids Player</div>
      <div class="tips">Ph√≠m t·∫Øt: <span class="kbd">‚Üê</span> Prev ‚Ä¢ <span class="kbd">‚Üí</span> Next ‚Ä¢ <span class="kbd">Space</span> Play ‚Ä¢ <span class="kbd">S</span> Shuffle ‚Ä¢ <span class="kbd">E</span> S·ª≠a d·ªãch</div>
    </div>

    <div class="card">
      <div class="desc" id="desc">‚Äî</div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="trans">D·ªãch nghƒ©a</button>
        <button class="tab-btn" data-tab="record">Ghi √¢m</button>
        <button class="tab-btn" id="createJsonTab">T·∫°o file JSON</button>
      </div>

      <!-- Translation block -->
      <div class="trans tab-content active" id="transBlock">
        <div><span class="label">D·ªãch nghƒ©a (VI):</span><span id="viText" class="viText empty">(ch∆∞a c√≥ d·ªãch)</span></div>
        <div class="row">
          <button class="btn" id="editTransBtn" title="S·ª≠a d·ªãch (E)">‚úèÔ∏è S·ª≠a d·ªãch</button>
        </div>
        <div id="editTransBox" hidden>
          <textarea id="viTextarea" placeholder="Nh·∫≠p b·∫£n d·ªãch ti·∫øng Vi·ªát cho c√¢u n√†y..."></textarea>
          <div class="row">
            <button class="btn good" id="saveTransBtn" title="L∆∞u (Ctrl/‚åò + Enter)">L∆∞u</button>
            <button class="btn" id="cancelTransBtn">H·ªßy</button>
          </div>
        </div>
      </div>

      <!-- Recording block -->
      <div class="record tab-content" id="recordBlock">
        <div><span class="label">Ghi √¢m c·ªßa b·∫°n:</span></div>
        <div class="row">
          <button class="btn" id="startRecordBtn">
            <span id="startIcon">üé§</span> B·∫Øt ƒë·∫ßu ghi
          </button>
          <button class="btn bad" id="stopRecordBtn" disabled>
            <span id="stopIcon">‚èπ</span> D·ª´ng ghi
          </button>
          <button class="btn good" id="playRecordBtn" disabled>
            <span id="playIcon">‚ñ∂</span> <span id="playText">Ph√°t l·∫°i b·∫£n ghi</span>
          </button>
        </div>
        <audio id="recordAudio" controls style="display:none; width:100%; margin-top:8px;"></audio>
        <div class="status" id="recordStatus">Ch∆∞a ghi √¢m.</div>
      </div>

      <div class="embed" id="embedBox" aria-live="polite"></div>
    </div>

    <div class="grid">
      <div class="controls">
        <button class="btn" id="goFirst" title="V·ªÅ ƒë·∫ßu">‚§í First</button>
        <button class="btn" id="prevBtn2">‚ü∂ Prev</button>
        <button class="btn primary" id="playBtn2">‚ñ∂ Play</button>
        <button class="btn" id="nextBtn2">Next ‚ü∂</button>
        <button class="btn" id="goLast" title="V·ªÅ cu·ªëi">Last ‚§ì</button>
        <button class="btn bad" id="clearData" title="X√≥a d·ªØ li·ªáu ƒë√£ n·∫°p (tr·∫£ v·ªÅ m√†n h√¨nh n·∫°p d·ªØ li·ªáu)">Clear</button>
      </div>
      <div class="row">
        <span class="status" id="status">S·∫µn s√†ng. B·∫•m Next ƒë·ªÉ chuy·ªÉn.</span>
      </div>
    </div>
  </div>

  <div class="footer">
    T·ªáp m·ªôt trang ‚Äî kh√¥ng c·∫ßn c√†i ƒë·∫∑t. D·ªØ li·ªáu & thi·∫øt l·∫≠p (k·ªÉ c·∫£ b·∫£n d·ªãch b·∫°n nh·∫≠p) l∆∞u t·∫°m trong tr√¨nh duy·ªát (localStorage).
  </div>
</div>

<script>
/** ========= Sample data ========= **/
const sampleData = [
  {"embed":"<div><iframe width=\"300\" height=\"60\" src=\"https://v...content-available-to-author-only...o.com/embed/1oVlWTzmTEBy?autoplay=0\" frameborder=\"0\" allow=\"autoplay\"></iframe><br><a href=\"  https://v...content-available-to-author-only...a.ro/1oVlWTzmTEBy  \" title=\"Vocaroo Voice Recorder\" target=\"_blank\">View on Vocaroo >></a></div>","description":"Guten Tag, Frau Herbst.","vi":"Ch√†o b√† Herbst."},
  {"embed":"<div><iframe width=\"300\" height=\"60\" src=\"https://v...content-available-to-author-only...o.com/embed/1cro2DaHoYlR?autoplay=0\" frameborder=\"0\" allow=\"autoplay\"></iframe><br><a href=\"  https://v...content-available-to-author-only...a.ro/1cro2DaHoYlR  \" title=\"Vocaroo Voice Recorder\" target=\"_blank\">View on Vocaroo >></a></div>","description":"guten Abend"},
  {"embed":"<div><iframe width=\"300\" height=\"60\" src=\"https://v...content-available-to-author-only...o.com/embed/1eswyrRXX5yb?autoplay=0\" frameborder=\"0\" allow=\"autoplay\"></iframe><br><a href=\"  https://v...content-available-to-author-only...a.ro/1eswyrRXX5yb  \" title=\"Vocaroo Voice Recorder\" target=\"_blank\">View on Vocaroo >></a></div>","description":"guten Morgen"},
  {"embed":"<div><iframe width=\"300\" height=\"60\" src=\"https://v...content-available-to-author-only...o.com/embed/1a72mNvGgKzc?autoplay=0\" frameborder=\"0\" allow=\"autoplay\"></iframe><br><a href=\"  https://v...content-available-to-author-only...a.ro/1a72mNvGgKzc  \" title=\"Vocaroo Voice Recorder\" target=\"_blank\">View on Vocaroo >></a></div>","description":"Sie"},
  {"embed":"<div><iframe width=\"300\" height=\"60\" src=\"https://v...content-available-to-author-only...o.com/embed/11hl1Zg9zWij?autoplay=0\" frameborder=\"0\" allow=\"autoplay\"></iframe><br><a href=\"  https://v...content-available-to-author-only...a.ro/11hl1Zg9zWij  \" title=\"Vocaroo Voice Recorder\" target=\"_blank\">View on Vocaroo >></a></div>","description":"Guten Abend, ich hei√üe Herbst, Peter Herbst. Und wie hei√üen Sie?"},
  {"embed":"<div><iframe width=\"300\" height=\"60\" src=\"https://v...content-available-to-author-only...o.com/embed/1cOcuOb1A4Eb?autoplay=0\" frameborder=\"0\" allow=\"autoplay\"></iframe><br><a href=\"  https://v...content-available-to-author-only...a.ro/1cOcuOb1A4Eb  \" title=\"Vocaroo Voice Recorder\" target=\"_blank\">View on Vocaroo >></a></div>","description":"Ich hei√üe M√ºller, Johann M√ºller."},
  {"embed":"<div><iframe width=\"300\" height=\"60\" src=\"https://v...content-available-to-author-only...o.com/embed/1cTsTpwacKwU?autoplay=0\" frameborder=\"0\" allow=\"autoplay\"></iframe><br><a href=\"  https://v...content-available-to-author-only...a.ro/1cTsTpwacKwU  \" title=\"Vocaroo Voice Recorder\" target=\"_blank\">View on Vocaroo >></a></div>","description":"Guten Morgen, ich hei√üe Ingrid. Und wie hei√üt du?"},
  {"embed":"<div><iframe width=\"300\" height=\"60\" src=\"https://v...content-available-to-author-only...o.com/embed/12fJ5RqCs63b?autoplay=0\" frameborder=\"0\" allow=\"autoplay\"></iframe><br><a href=\"  https://v...content-available-to-author-only...a.ro/12fJ5RqCs63b  \" title=\"Vocaroo Voice Recorder\" target=\"_blank\">View on Vocaroo >></a></div>","description":"Ich hei√üe Karin."},
  {"embed":"<div><iframe width=\"300\" height=\"60\" src=\"https://v...content-available-to-author-only...o.com/embed/164y5W9n6nSe?autoplay=0\" frameborder=\"0\" allow=\"autoplay\"></iframe><br><a href=\"  https://v...content-available-to-author-only...a.ro/164y5W9n6nSe  \" title=\"Vocaroo Voice Recorder\" target=\"_blank\">View on Vocaroo >></a></div>","description":"In German, all nouns are capitalized."},
  {"embed":"<div><iframe width=\"300\" height=\"60\" src=\"https://v...content-available-to-author-only...o.com/embed/1m27KHgJcnSF?autoplay=0\" frameborder=\"0\" allow=\"autoplay\"></iframe><br><a href=\"  https://v...content-available-to-author-only...a.ro/1m27KHgJcnSF  \" title=\"Vocaroo Voice Recorder\" target=\"_blank\">View on Vocaroo >></a></div>","description":"Ich"}
];

/** ========= State ========= **/
const state = { items: [], order: [], pos: 0, shuffle: false, fontScale: 1.4, mediaRecorder: null, recordedBlob: null };

/** ========= Elements ========= **/
const loader = document.getElementById('loader');
const playerPanel = document.getElementById('playerPanel');
const descEl = document.getElementById('desc');
const embedBox = document.getElementById('embedBox');
const indexInfo = document.getElementById('indexInfo');
const statusEl = document.getElementById('status');
const countTag = document.getElementById('countTag');

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const playBtn = document.getElementById('playBtn');
const prevBtn2 = document.getElementById('prevBtn2');
const nextBtn2 = document.getElementById('nextBtn2');
const playBtn2 = document.getElementById('playBtn2');
const goFirst = document.getElementById('goFirst');
const goLast = document.getElementById('goLast');
const clearData = document.getElementById('clearData');
const shuffleBtn = document.getElementById('shuffleBtn');
const fontRange = document.getElementById('fontRange');

const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const jsonTextarea = document.getElementById('jsonTextarea');
const loadFromTextarea = document.getElementById('loadFromTextarea');
const useSample = document.getElementById('useSample');

// Translation UI
const viText = document.getElementById('viText');
const editTransBtn = document.getElementById('editTransBtn');
const editTransBox = document.getElementById('editTransBox');
const viTextarea = document.getElementById('viTextarea');
const saveTransBtn = document.getElementById('saveTransBtn');
const cancelTransBtn = document.getElementById('cancelTransBtn');

// Recording UI
const startRecordBtn = document.getElementById('startRecordBtn');
const stopRecordBtn = document.getElementById('stopRecordBtn');
const playRecordBtn = document.getElementById('playRecordBtn');
const recordAudio = document.getElementById('recordAudio');
const recordStatus = document.getElementById('recordStatus');
const tabBtns = document.querySelectorAll('.tab-btn:not(#createJsonTab)');
const tabContents = document.querySelectorAll('.tab-content');

// === Th√™m s·ª± ki·ªán cho tab "T·∫°o file JSON" ===
document.getElementById('createJsonTab').addEventListener('click', () => {
  window.open('https://v0-ai-prompt-generator-mocha.vercel.app/', '_blank');
});

/** ========= Helpers + Auto-translate ========= */

function normalizeDe(s){
  return String(s||'')
    .toLowerCase()
    .normalize('NFC')
    .replace(/[.,!?;:()\[\]{}"‚Äú‚Äù‚Äò‚Äô]/g,'')
    .replace(/\s+/g,' ')
    .trim();
}

const DICT_DE_VI = new Map([
  ['guten tag', 'Ch√†o bu·ªïi tr∆∞a/Ch√∫c m·ªôt ng√†y t·ªët l√†nh'],
  ['guten morgen', 'Ch√†o bu·ªïi s√°ng'],
  ['guten abend', 'Ch√†o bu·ªïi t·ªëi'],
  ['gute nacht', 'Ch√∫c ng·ªß ngon'],
  ['hallo', 'Xin ch√†o'],
  ['ich', 'T√¥i'],
  ['sie', 'Ng√†i/√îng/B√† (c√°ch x∆∞ng l·ªãch s·ª±)'],
  ['du', 'B·∫°n (th√¢n m·∫≠t)'],
  ['und wie hei√üt du', 'C√≤n b·∫°n t√™n l√† g√¨?'],
  ['und wie hei√üen sie', 'C√≤n ng√†i t√™n l√† g√¨?'],
  ['in german all nouns are capitalized', 'Trong ti·∫øng ƒê·ª©c, t·∫•t c·∫£ danh t·ª´ ƒë·ªÅu vi·∫øt hoa.'],
]);

function autoViByPatterns(original){
  const norm = normalizeDe(original);

  let m1 = norm.match(/^ich hei√üe (.+)$/);
  if(m1){
    const nameRaw = (/ich hei√üe\s+(.+)$/i.exec(original) || [,''])[1].trim();
    return nameRaw ? `T√¥i t√™n l√† ${nameRaw}.` : 'T√¥i t√™n l√† ‚Ä¶';
  }

  let m2 = norm.match(/^guten tag,\s*(frau|herr)\s+(.+)$/);
  if(m2){
    const honor = m2[1]==='frau' ? 'b√†' : '√¥ng';
    const rawName = (/Guten Tag,\s*(Frau|Herr)\s+(.+)$/i.exec(original) || []).slice(2).join(' ').trim();
    return rawName ? `Ch√†o ${honor} ${rawName}.` : `Ch√†o ${honor}.`;
  }

  let m3 = norm.match(/^wie hei√üt (du|sie)\??$/);
  if(m3){ return m3[1]==='du' ? 'B·∫°n t√™n l√† g√¨?' : 'Ng√†i t√™n l√† g√¨?'; }

  return '';
}

function autoVi(desc){
  if(!desc) return '';
  const norm = normalizeDe(desc);
  if(DICT_DE_VI.has(norm)) return DICT_DE_VI.get(norm);
  const byPat = autoViByPatterns(desc);
  if(byPat) return byPat;
  return '';
}

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function shuffleArray(a){ const arr = a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

function setStatus(msg){ statusEl.textContent = msg; }
function saveLocal(){
  const payload = { items: state.items, shuffle: state.shuffle, fontScale: state.fontScale };
  try { localStorage.setItem('deKidsPlayer', JSON.stringify(payload)); } catch {}
}
function loadLocal(){
  try {
    const s = localStorage.getItem('deKidsPlayer');
    if(!s) return null;
    const p = JSON.parse(s);
    if(Array.isArray(p.items) && p.items.length) return p;
  } catch {}
  return null;
}
function applyFontScale(){
  const v = clamp(Number(state.fontScale)||1.4, 0.8, 1.8);
  document.documentElement.style.setProperty('--fontScale', v);
  fontRange.value = v;
}

function buildOrder(keepCurrent=false){
  const n = state.items.length;
  let base = Array.from({length:n}, (_,i)=>i);
  if(state.shuffle) base = shuffleArray(base);
  if(keepCurrent){
    const cur = state.order[state.pos] ?? 0;
    const idxInNew = base.indexOf(cur);
    if(idxInNew >= 0){ state.order = base; state.pos = idxInNew; return; }
  }
  state.order = base; state.pos = 0;
}

function currentItem(){ if(!state.items.length) return null; const idx = state.order[state.pos] ?? 0; return { idx, data: state.items[idx] }; }

/** Sanitize + t·ª± sinh nghƒ©a n·∫øu thi·∫øu **/
function sanitizeItem(raw){
  if(!raw || typeof raw !== 'object') return null;
  const embed = String(raw.embed ?? '').trim();
  const description = String(raw.description ?? '').trim();
  // üëá ∆ØU TI√äN vietnameseTranslation
  const viField = (
    raw.vietnameseTranslation ??
    raw.vi ??
    raw.vn ??
    raw.translation ??
    raw.meaning ??
    ''
  );
  let vi = String(viField ?? '').trim();
  if(!embed || !description) return null;
  if(!/<iframe[\s\S]*?>/i.test(embed)) return null;
  if(!vi){ vi = autoVi(description); }
  return { embed, description, vi };
}

function render(){
  const cur = currentItem();
  if(!cur){
    descEl.textContent = '‚Äî'; embedBox.innerHTML=''; countTag.textContent='0 / 0'; indexInfo.textContent='‚Äî';
    viText.textContent='(ch∆∞a c√≥ d·ªãch)'; viText.classList.add('empty');
    stopRecording();
    return;
  }
  descEl.textContent = cur.data.description;
  embedBox.innerHTML = cur.data.embed;
  indexInfo.textContent = `#${cur.idx+1}`;
  countTag.textContent = `${cur.idx+1} / ${state.items.length}`;

  const t = (cur.data.vi || autoVi(cur.data.description) || '').trim();
  if(t){ viText.textContent = t; viText.classList.remove('empty'); } else { viText.textContent = '(ch∆∞a c√≥ d·ªãch)'; viText.classList.add('empty'); }

  editTransBox.hidden = true;
  setStatus(`ƒêang ·ªü m·ª•c #${cur.idx+1}. B·∫•m Next ƒë·ªÉ chuy·ªÉn. B·∫•m E ƒë·ªÉ s·ª≠a d·ªãch.`);
}

function next(){ if(!state.items.length) return; state.pos = (state.pos + 1) % state.order.length; render(); saveLocal(); }
function prev(){ if(!state.items.length) return; state.pos = (state.pos - 1 + state.order.length) % state.order.length; render(); saveLocal(); }
function goFirstFn(){ if(!state.items.length) return; state.pos = 0; render(); saveLocal(); }
function goLastFn(){ if(!state.items.length) return; state.pos = state.order.length-1; render(); saveLocal(); }
function toggleShuffle(){ state.shuffle = !state.shuffle; shuffleBtn.setAttribute('aria-pressed', state.shuffle ? 'true' : 'false'); buildOrder(true); render(); saveLocal(); }

function playCurrent(){
  const frame = embedBox.querySelector('iframe');
  if(!frame || !frame.src){ setStatus('Kh√¥ng t√¨m th·∫•y iframe ƒë·ªÉ ph√°t.'); return; }
  try {
    const url = new URL(frame.src);
    url.searchParams.set('autoplay','1');
    url.searchParams.set('_t', String(Date.now()));
    frame.src = url.toString();
    setStatus('ƒêang ph√°t‚Ä¶ (kh√¥ng t·ª± chuy·ªÉn)');
  } catch {
    const { data } = currentItem();
    embedBox.innerHTML = data.embed;
    setStatus('ƒêang ph√°t (kh·ªüi ƒë·ªông l·∫°i)‚Ä¶ (kh√¥ng t·ª± chuy·ªÉn)');
  }
}

function parseJSON(text){
  const obj = JSON.parse(text);
  if(!Array.isArray(obj)) throw new Error('JSON ph·∫£i l√† m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng.');
  const items = obj.map(sanitizeItem).filter(Boolean);
  if(!items.length) throw new Error('Kh√¥ng c√≥ m·ª•c h·ª£p l·ªá (c·∫ßn {embed, description}).');
  return items;
}
function loadItems(items){
  state.items = items;
  buildOrder(false);
  render();
  loader.hidden = true;
  playerPanel.hidden = false;
  setStatus(`ƒê√£ n·∫°p ${items.length} m·ª•c. B·∫•m Next ƒë·ªÉ chuy·ªÉn, ho·∫∑c E ƒë·ªÉ s·ª≠a d·ªãch.`);
  saveLocal();
}

// ===== Translation editing =====
function openEdit(){
  const cur = currentItem(); if(!cur) return;
  viTextarea.value = cur.data.vi || autoVi(cur.data.description) || '';
  editTransBox.hidden = false;
  viTextarea.focus();
}
function saveEdit(){
  const cur = currentItem(); if(!cur) return;
  const text = (viTextarea.value || '').trim();
  state.items[cur.idx].vi = text;
  saveLocal();
  render();
}
function cancelEdit(){ editTransBox.hidden = true; }

editTransBtn.addEventListener('click', openEdit);
saveTransBtn.addEventListener('click', saveEdit);
cancelTransBtn.addEventListener('click', cancelEdit);

// ===== Tab switching =====
tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;
    tabBtns.forEach(b => b.classList.remove('active'));
    tabContents.forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.querySelector(`#${tab}Block`).classList.add('active');
  });
});

// ===== Recording logic =====
async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg';
    state.mediaRecorder = new MediaRecorder(stream, { mimeType });
    const chunks = [];

    state.mediaRecorder.ondataavailable = e => chunks.push(e.data);
    state.mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: mimeType });
      state.recordedBlob = blob;
      const url = URL.createObjectURL(blob);
      recordAudio.src = url;
      playRecordBtn.disabled = false;
      recordStatus.textContent = 'ƒê√£ ghi xong. B·∫•m "Ph√°t l·∫°i b·∫£n ghi" ƒë·ªÉ nghe.';

      // üëá Tr·ªü v·ªÅ icon mic sau khi d·ª´ng
      document.getElementById('startIcon').textContent = 'üé§';
      stopRecordBtn.disabled = true;
      startRecordBtn.disabled = false;
    };

    state.mediaRecorder.start();
    startRecordBtn.disabled = true;
    stopRecordBtn.disabled = false;

    // üëá Thay icon b·∫±ng ch·∫•m ƒë·ªè nh·∫•p nh√°y
    document.getElementById('startIcon').innerHTML = '<span class="recording-dot"></span>';

    recordStatus.textContent = 'ƒêang ghi...';
  } catch (err) {
    recordStatus.textContent = 'L·ªói: ' + (err.message || 'Kh√¥ng th·ªÉ truy c·∫≠p mic.');
    console.error(err);
  }
}

function stopRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
    state.mediaRecorder.stop();
    state.mediaRecorder.stream.getTracks().forEach(track => track.stop());
    startRecordBtn.disabled = false;
    stopRecordBtn.disabled = true;
    // üëá Reset icon v·ªÅ mic
    document.getElementById('startIcon').textContent = 'üé§';
  }
}

function togglePlayPause() {
  if (!recordAudio.src) return;

  if (recordAudio.paused) {
    recordAudio.play();
    document.getElementById('playIcon').textContent = '‚è∏';
    document.getElementById('playText').textContent = 'T·∫°m d·ª´ng';
  } else {
    recordAudio.pause();
    document.getElementById('playIcon').textContent = '‚ñ∂';
    document.getElementById('playText').textContent = 'Ti·∫øp t·ª•c';
  }
}

// Add event to reset button text when playback ends
recordAudio.addEventListener('ended', () => {
  document.getElementById('playIcon').textContent = '‚ñ∂';
  document.getElementById('playText').textContent = 'Ph√°t l·∫°i b·∫£n ghi';
});

startRecordBtn.addEventListener('click', startRecording);
stopRecordBtn.addEventListener('click', stopRecording);
playRecordBtn.addEventListener('click', togglePlayPause);

// D·ª´ng ghi khi chuy·ªÉn c√¢u
const originalNext = next;
const originalPrev = prev;
const originalGoFirst = goFirstFn;
const originalGoLast = goLastFn;

next = () => { stopRecording(); originalNext(); };
prev = () => { stopRecording(); originalPrev(); };
goFirstFn = () => { stopRecording(); originalGoFirst(); };
goLastFn = () => { stopRecording(); originalGoLast(); };

// ===== File loading / DnD =====
dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', async (e)=>{
  e.preventDefault(); dropZone.classList.remove('dragover');
  const f = e.dataTransfer.files?.[0]; if(!f) return;
  try { const txt = await f.text(); const items = parseJSON(txt); loadItems(items); }
  catch(err){ setStatus('L·ªói ƒë·ªçc t·ªáp: ' + (err?.message || err)); }
});

fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try { const txt = await f.text(); const items = parseJSON(txt); loadItems(items); }
  catch(err){ setStatus('L·ªói ƒë·ªçc t·ªáp: ' + (err?.message || err)); }
  finally { fileInput.value = ''; }
});

loadFromTextarea.addEventListener('click', ()=>{
  try { const items = parseJSON(jsonTextarea.value); loadItems(items); }
  catch(err){ setStatus('L·ªói JSON: ' + (err?.message || err)); }
});

useSample.addEventListener('click', ()=> { loadItems(sampleData); });

// ===== Controls =====
prevBtn.addEventListener('click', prev);
nextBtn.addEventListener('click', next);
playBtn.addEventListener('click', playCurrent);
prevBtn2.addEventListener('click', prev);
nextBtn2.addEventListener('click', next);
playBtn2.addEventListener('click', playCurrent);
goFirst.addEventListener('click', goFirstFn);
goLast.addEventListener('click', goLastFn);
clearData.addEventListener('click', ()=>{
  localStorage.removeItem('deKidsPlayer');
  state.items = []; state.order = []; state.pos = 0;
  loader.hidden = true; playerPanel.hidden = true;
  setStatus('ƒê√£ x√≥a d·ªØ li·ªáu ƒë√£ n·∫°p. H√£y n·∫°p l·∫°i d·ªØ li·ªáu.');
});

// ===== Keyboard shortcuts =====
document.addEventListener('keydown', (e)=>{
  if(e.target.matches('textarea, input')) return;
  if(e.key === 'ArrowLeft') prev();
  else if(e.key === 'ArrowRight') next();
  else if(e.code === 'Space') { e.preventDefault(); playCurrent(); }
  else if(e.key.toLowerCase() === 's') toggleShuffle();
  else if(e.key.toLowerCase() === 'e') openEdit();
});

// ===== Init =====
fontRange.addEventListener('input', ()=>{
  state.fontScale = Number(fontRange.value);
  applyFontScale();
  saveLocal();
});

applyFontScale();

const saved = loadLocal();
if(saved){
  state.items = saved.items;
  state.shuffle = saved.shuffle;
  state.fontScale = saved.fontScale;
  applyFontScale();
  buildOrder(false);
  loader.hidden = true;
  playerPanel.hidden = false;
  render();
  setStatus(`ƒê√£ kh√¥i ph·ª•c ${state.items.length} m·ª•c t·ª´ l·∫ßn tr∆∞·ªõc.`);
} else {
  setStatus('Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y n·∫°p file JSON ho·∫∑c d√πng m·∫´u.');
}
</script>
</body>
</html>
